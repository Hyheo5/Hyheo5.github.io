<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GraphCraft - Project Management</title>
    <style>
        /* --- Global Styles & Resets --- */
        :root {
            --bg-main: #1a1a1c;
            --bg-panel: #242426;
            --bg-input: #2e2e30;
            --bg-node: #3a3a3c;
            --bg-node-hover: #4a4a4e;
            --border-color: #4a4a4e;
            --text-primary: #e1e1e1;
            --text-secondary: #a0a0a0;
            --accent-primary: #007bff;
            --accent-secondary: #17a2b8;
            --danger: #dc3545;
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        body {
            font-family: var(--font-main);
            background-color: var(--bg-main);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            height: 100vh;
            width: 100vw;
        }
        * { box-sizing: border-box; }

        /* --- React Flow Customizations --- */
        .react-flow__pane { background-color: var(--bg-main) !important; }
        .react-flow__attribution { background: rgba(0,0,0,0.5) !important; }
        .react-flow__controls { box-shadow: var(--shadow); }
        .react-flow__controls-button { background: var(--bg-panel); border-bottom: 1px solid var(--border-color); }
        .react-flow__controls-button:hover { background: var(--bg-input); }
        .react-flow__controls-button svg { fill: var(--text-primary); }
        .react-flow__minimap { background: var(--bg-panel); border: 1px solid var(--border-color); box-shadow: var(--shadow); }

        /* --- Main App Layout --- */
        #root {
            display: flex;
            width: 100%;
            height: 100%;
        }
        .main-content {
            flex-grow: 1;
            height: 100%;
            position: relative;
        }
        .sidebar {
            width: 350px;
            background-color: var(--bg-panel);
            border-left: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            height: 100%;
            transition: width 0.3s ease;
            box-shadow: var(--shadow);
        }
        .sidebar.collapsed {
            width: 0;
            padding: 0;
            overflow: hidden;
        }
        
        /* --- General UI Components --- */
        h1, h2, h3 { color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-top: 0; }
        label { display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.9em; }
        input[type="text"], input[type="number"], textarea {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        input[type="range"] { width: 100%; }
        button {
            background-color: var(--accent-primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: var(--bg-input); }
        button.secondary:hover { background-color: var(--bg-node); }
        button.danger { background-color: var(--danger); }
        button.danger:hover { background-color: #a72836; }

        /* --- Command Bar --- */
        .command-bar {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            background: var(--bg-panel);
            padding: 10px;
            border-radius: 6px;
            box-shadow: var(--shadow);
            z-index: 10;
        }
        .command-bar input { min-width: 300px; margin-bottom: 0; }
        .command-bar p { margin: 0; font-size: 0.8em; color: var(--text-secondary); }


        /* --- Sidebar Content --- */
        .sidebar-placeholder { text-align: center; color: var(--text-secondary); margin-top: 50px; }
        .sidebar-placeholder h3 { border: none; }
        .property-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .property-item span { color: var(--text-secondary); }

        /* --- User Panel (in Sidebar) --- */
        .user-panel { margin-top: 20px; }
        .user-list { list-style: none; padding: 0; margin: 10px 0; }
        .user-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 5px;
            background: var(--bg-input);
        }
        .user-flag {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            cursor: grab;
        }
        .user-item span { flex-grow: 1; }
        .user-add-form { display: flex; gap: 5px; }

        /* --- Custom Node Styles --- */
        .custom-node {
            width: 120px;
            height: 120px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
        }
        .custom-node .node-pie-bg { fill: var(--bg-node); }
        .custom-node .node-pie-progress { fill: var(--accent-secondary); transition: all 0.3s ease; }
        .custom-node:hover .node-pie-bg { fill: var(--bg-node-hover); }
        .custom-node .node-label {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
            pointer-events: none;
            max-width: 80%;
        }
        .node-flags-container {
            position: absolute;
            top: -5px;
            right: -5px;
            display: flex;
            gap: 2px;
        }
        .node-flag {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--bg-main);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        /* --- Hover Tooltip --- */
        .hover-tooltip {
            position: absolute;
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 6px;
            z-index: 100;
            pointer-events: none;
            box-shadow: var(--shadow);
            max-width: 250px;
        }
        .hover-tooltip h4 { margin: 0 0 5px 0; }
        .hover-tooltip p { margin: 0; font-size: 0.9em; color: var(--text-secondary); }

        /* --- Settings Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--bg-panel);
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
        }
        .modal-properties-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .modal-property-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-input);
            padding: 5px 8px;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        .modal-add-property {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/react-flow-renderer@10.3.17/dist/umd/react-flow-renderer.min.js"></script>
    <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
    <script src="https://unpkg.com/nanoid@4.0.0/nanoid.js"></script>
    
    <script type="module">
        const {
            useState,
            useEffect,
            useCallback,
            useMemo,
            useRef
        } = React;
        const {
            ReactFlow,
            ReactFlowProvider,
            useNodesState,
            useEdgesState,
            useReactFlow,
            Controls,
            Background,
            applyNodeChanges,
            applyEdgeChanges,
        } = ReactFlowRenderer;

        // HTM (Hyperscript Tagged Markup) to use JSX-like syntax in the browser
        const html = htm.bind(React.createElement);

        // --- Initial Data (Minecraft Example) ---
        const initialNodes = [
            { id: '1', type: 'custom', position: { x: 400, y: 100 }, data: { label: 'Build Enchanting Table', progress: 10, properties: { Assignee: 'Team', Due: 'Next Week', Status: 'In Progress' }, flags: [] } },
            { id: '2', type: 'custom', position: { x: 100, y: 300 }, data: { label: 'Gather Diamonds', progress: 25, properties: { Assignee: 'Steve', Due: 'Tomorrow', Status: 'In Progress' }, flags: ['user-alex'] } },
            { id: '3', type: 'custom', position: { x: 400, y: 300 }, data: { label: 'Gather Obsidian', progress: 0, properties: { Assignee: 'Alex', Due: 'Tomorrow', Status: 'Not Started' }, flags: [] } },
            { id: '4', type: 'custom', position: { x: 700, y: 300 }, data: { label: 'Gather Books', progress: 90, properties: { Assignee: 'Steve', Due: 'Today', Status: 'Review' }, flags: [] } },
            { id: '5', type: 'custom', position: { x: 100, y: 500 }, data: { label: 'Craft Iron Pickaxe', progress: 100, properties: { Assignee: 'Alex', Due: 'Done', Status: 'Complete' }, flags: [] } },
            { id: '6', type: 'custom', position: { x: 400, y: 500 }, data: { label: 'Chop Wood', progress: 75, properties: { Assignee: 'Steve', Due: 'Ongoing', Status: 'In Progress' }, flags: ['user-steve'] } },
            { id: '7', type: 'custom', position: { x: 700, y: 500 }, data: { label: 'Raise Livestock', progress: 60, properties: { Assignee: 'Alex', Due: 'This Week', Status: 'In Progress' }, flags: [] } },
            { id: '8', type: 'custom', position: { x: 1000, y: 300 }, data: { label: 'Build Villager Trading Hall', progress: 5, properties: { Assignee: 'Team', Due: 'Next Month', Status: 'Planning' }, flags: [] } },
        ];

        // Edges point FROM sub-task TO parent task
        const initialEdges = [
            { id: 'e2-1', source: '2', target: '1', animated: true, markerEnd: { type: 'arrowclosed' } },
            { id: 'e3-1', source: '3', target: '1', animated: true, markerEnd: { type: 'arrowclosed' } },
            { id: 'e4-1', source: '4', target: '1', animated: true, markerEnd: { type: 'arrowclosed' } },
            { id: 'e5-2', source: '5', target: '2', markerEnd: { type: 'arrowclosed' } },
            { id: 'e6-5', source: '6', target: '5', markerEnd: { type: 'arrowclosed' } },
            { id: 'e7-4', source: '7', target: '4', markerEnd: { type: 'arrowclosed' } }, // Re-using livestock for books (leather)
            { id: 'e7-8', source: '7', target: '8', animated: true, markerEnd: { type: 'arrowclosed' } }, // And for trading hall
            { id: 'e6-8', source: '6', target: '8', animated: true, markerEnd: { type: 'arrowclosed' } }, // Re-using wood
        ];

        // --- Custom Node Component (Feature 2.2) ---
        const CustomNode = ({ data }) => {
            const getArcPath = (progress) => {
                if (progress >= 100) progress = 99.99;
                const radius = 50;
                const x = radius + Math.sin(2 * Math.PI * (progress / 100)) * radius;
                const y = radius - Math.cos(2 * Math.PI * (progress / 100)) * radius;
                const largeArcFlag = progress > 50 ? 1 : 0;
                return `M ${radius},0 A ${radius},${radius} 0 ${largeArcFlag} 1 ${x},${y}`;
            };
            
            const userColors = {
              'user-steve': '#5cb85c',
              'user-alex': '#5bc0de',
              'user-herobrine': '#f0ad4e',
            };

            return html`
                <div className="custom-node">
                    <svg viewBox="0 0 120 120" width="120" height="120" style=${{position: 'absolute'}}>
                        <circle className="node-pie-bg" cx="60" cy="60" r="55" />
                        ${data.progress > 0 && html`<path className="node-pie-progress" d=${getArcPath(data.progress)} transform="translate(10, 10)" strokeWidth="100" />`}
                        <circle cx="60" cy="60" r="48" fill=${'var(--bg-main)'} />
                    </svg>
                    <div className="node-label">${data.label}</div>
                    <div className="node-flags-container">
                        ${data.flags.map(flagId => {
                            const user = USERS.find(u => u.id === flagId);
                            if (!user) return null;
                            return html`<div key=${flagId} className="node-flag" style=${{ backgroundColor: user.color }} title=${user.name}>${user.name.charAt(0)}</div>`
                        })}
                    </div>
                </div>
            `;
        };
        const nodeTypes = { custom: CustomNode };
        
        // --- Hardcoded User Data & Colors (Feature 2.4) ---
        const USER_COLORS = ['#5cb85c', '#5bc0de', '#f0ad4e', '#d9534f', '#428bca'];
        const USERS = [
            { id: 'user-steve', name: 'Steve', color: USER_COLORS[0] },
            { id: 'user-alex', name: 'Alex', color: USER_COLORS[1] },
        ];

        // --- Sidebar Component (Displays Node Details) ---
        const NodeSidebar = ({ activeNode, updateNodeData, deleteNode }) => {
            if (!activeNode) {
                return html`
                    <div className="sidebar-placeholder">
                        <h3>Select a Node</h3>
                        <p>Click on a node in the graph to view and edit its details.</p>
                    </div>
                `;
            }

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                updateNodeData(activeNode.id, { ...activeNode.data, [name]: value });
            };
            
            const handleProgressChange = (e) => {
                updateNodeData(activeNode.id, { ...activeNode.data, progress: parseInt(e.target.value, 10) });
            };
            
            const handlePropertyChange = (key, value) => {
                const newProperties = { ...activeNode.data.properties, [key]: value };
                updateNodeData(activeNode.id, { ...activeNode.data, properties: newProperties });
            };

            return html`
                <div>
                    <h2>Node Details</h2>
                    <label htmlFor="label">Title</label>
                    <input type="text" id="label" name="label" value=${activeNode.data.label} onChange=${handleInputChange} />
                    
                    <label>Progress: ${activeNode.data.progress}%</label>
                    <input type="range" min="0" max="100" value=${activeNode.data.progress} onChange=${handleProgressChange} />

                    <h3>Properties</h3>
                    <div>
                        ${Object.entries(activeNode.data.properties).map(([key, value]) => html`
                            <div key=${key} className="property-item">
                                <label>${key}</label>
                                <input type="text" value=${value} onChange=${(e) => handlePropertyChange(key, e.target.value)} style=${{width: '60%', marginBottom: 0}} />
                            </div>
                        `)}
                    </div>
                    
                    <h3 style=${{ marginTop: '20px' }}>Notes</h3>
                    <textarea name="notes" rows="6" placeholder="Add rich text, checklists, etc. here..." value=${activeNode.data.notes || ''} onChange=${handleInputChange}></textarea>
                    
                    <button className="danger" onClick=${() => deleteNode(activeNode.id)} style=${{marginTop: '20px', width: '100%'}}>Delete Node</button>
                </div>
            `;
        };

        // --- User Panel Component (Feature 2.4) ---
        const UserPanel = ({ users, addUser, removeUser }) => {
            const [newUserName, setNewUserName] = useState('');

            const handleAddUser = (e) => {
                e.preventDefault();
                if (newUserName.trim()) {
                    addUser(newUserName.trim());
                    setNewUserName('');
                }
            };
            
            const onDragStart = (event, userId) => {
                event.dataTransfer.setData('application/reactflow', userId);
                event.dataTransfer.effectAllowed = 'move';
            };

            return html`
                <div className="user-panel">
                    <h2>Team Members & Flags</h2>
                    <p style=${{fontSize: '0.8em', color: 'var(--text-secondary)'}}>Drag a flag onto a node to assign yourself.</p>
                    <ul className="user-list">
                        ${users.map(user => html`
                            <li key=${user.id} className="user-item" draggable onDragStart=${(e) => onDragStart(e, user.id)}>
                                <div className="user-flag" style=${{ backgroundColor: user.color }}></div>
                                <span>${user.name}</span>
                                <button className="secondary" onClick=${() => removeUser(user.id)}>✖</button>
                            </li>
                        `)}
                    </ul>
                    <form className="user-add-form" onSubmit=${handleAddUser}>
                        <input type="text" placeholder="New member name..." value=${newUserName} onChange=${(e) => setNewUserName(e.target.value)} />
                        <button type="submit">Add</button>
                    </form>
                </div>
            `;
        };
        
        // --- Command Bar Component (Feature 2.3) ---
        const CommandBar = ({ onCommand }) => {
            const [command, setCommand] = useState('');

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    onCommand(command);
                    setCommand('');
                }
            };

            return html`
                <div className="command-bar">
                    <input 
                        type="text" 
                        value=${command} 
                        onChange=${(e) => setCommand(e.target.value)} 
                        onKeyDown=${handleKeyDown}
                        placeholder='Try: add node "My New Task"'
                    />
                    <div>
                        <p><strong>Commands:</strong></p>
                        <p><code>add node "Name"</code></p>
                        <p><code>add edge "Source" "Target"</code></p>
                        <p><code>del node "Name"</code></p>
                    </div>
                </div>
            `;
        };

        // --- Settings Modal (Feature 2.3) ---
        const SettingsModal = ({ isOpen, onClose, settings, updateSettings }) => {
            const [newProp, setNewProp] = useState('');

            if (!isOpen) return null;

            const addProperty = () => {
                if (newProp && !settings.globalProperties.includes(newProp)) {
                    updateSettings({ ...settings, globalProperties: [...settings.globalProperties, newProp] });
                    setNewProp('');
                }
            };

            const removeProperty = (propToRemove) => {
                updateSettings({ ...settings, globalProperties: settings.globalProperties.filter(p => p !== propToRemove) });
            };

            return html`
                <div className="modal-overlay" onClick=${onClose}>
                    <div className="modal-content" onClick=${e => e.stopPropagation()}>
                        <h2>Global Settings</h2>
                        <h3>Default Node Properties</h3>
                        <p style=${{fontSize: '0.8em', color: 'var(--text-secondary)'}}>These properties will be added to every new node.</p>
                        <div className="modal-properties-list">
                            ${settings.globalProperties.map(prop => html`
                                <div key=${prop} className="modal-property-item">
                                    <span>${prop}</span>
                                    <button className="secondary" onClick=${() => removeProperty(prop)}>Remove</button>
                                </div>
                            `)}
                        </div>
                        <div className="modal-add-property">
                            <input type="text" value=${newProp} onChange=${e => setNewProp(e.target.value)} placeholder="New property name..." />
                            <button onClick=${addProperty}>Add Property</button>
                        </div>
                        <button onClick=${onClose} style=${{marginTop: '20px', width: '100%'}}>Close</button>
                    </div>
                </div>
            `;
        };
        
        // --- Hover Tooltip Component (Feature 2.2) ---
        const HoverTooltip = ({ tooltip }) => {
            if (!tooltip) return null;
            
            const style = {
                left: `${tooltip.x + 15}px`,
                top: `${tooltip.y + 15}px`,
            };

            return html`
                <div className="hover-tooltip" style=${style}>
                    <h4>${tooltip.data.label}</h4>
                    <p><strong>Progress:</strong> ${tooltip.data.progress}%</p>
                    ${Object.entries(tooltip.data.properties).map(([key, value]) => html`
                        <p key=${key}><strong>${key}:</strong> ${value}</p>
                    `)}
                </div>
            `;
        };
        
        // --- Main App Component ---
        const App = () => {
            const reactFlowWrapper = useRef(null);
            const [nodes, setNodes, onNodesChange] = useNodesState(initialNodes);
            const [edges, setEdges, onEdgesChange] = useEdgesState(initialEdges);
            const [activeNodeId, setActiveNodeId] = useState(null);
            const [users, setUsers] = useState(USERS);
            const [isSettingsOpen, setSettingsOpen] = useState(false);
            const [tooltip, setTooltip] = useState(null);
            const [settings, setSettings] = useState({
                globalProperties: ['Assignee', 'Due Date', 'Status'],
            });

            const { project } = useReactFlow();

            // REAL-TIME NOTE: In a real app, you would use useEffect with a WebSocket or Firebase listener here.
            // Any state change (setNodes, setEdges, setUsers) would first be emitted to the server,
            // and the server would broadcast the new state to all clients. Clients would then update their
            // local state upon receiving the broadcast, ensuring sync.
            // Example:
            // useEffect(() => {
            //   socket.on('nodes_updated', (newNodes) => setNodes(newNodes));
            //   return () => socket.off('nodes_updated');
            // }, [setNodes]);

            const onConnect = useCallback((params) => setEdges((eds) => ReactFlowRenderer.addEdge({ ...params, animated: true, markerEnd: { type: 'arrowclosed' } }, eds)), [setEdges]);

            const onNodeClick = useCallback((event, node) => {
                setActiveNodeId(node.id);
            }, []);

            const onPaneClick = useCallback(() => {
                setActiveNodeId(null);
            }, []);
            
            const onNodeMouseEnter = useCallback((event, node) => {
                setTooltip({
                    id: node.id,
                    data: node.data,
                    x: event.clientX,
                    y: event.clientY,
                });
            }, []);

            const onNodeMouseLeave = useCallback(() => {
                setTooltip(null);
            }, []);

            const updateNodeData = useCallback((nodeId, newData) => {
                setNodes((nds) => nds.map((node) => {
                    if (node.id === nodeId) {
                        return { ...node, data: { ...node.data, ...newData } };
                    }
                    return node;
                }));
            }, [setNodes]);
            
            const deleteNode = useCallback((nodeIdToDelete) => {
                setNodes((nds) => nds.filter((node) => node.id !== nodeIdToDelete));
                setEdges((eds) => eds.filter((edge) => edge.source !== nodeIdToDelete && edge.target !== nodeIdToDelete));
                setActiveNodeId(null);
            }, [setNodes, setEdges]);
            
            const activeNode = useMemo(() => nodes.find(n => n.id === activeNodeId), [nodes, activeNodeId]);
            
            // --- User Management Logic (Feature 2.4) ---
            const addUser = useCallback((name) => {
                const newUser = {
                    id: `user-${nanoid.nanoid(8)}`,
                    name: name,
                    color: USER_COLORS[users.length % USER_COLORS.length]
                };
                setUsers(prev => [...prev, newUser]);
            }, [users]);
            
            const removeUser = useCallback((userId) => {
                setUsers(prev => prev.filter(u => u.id !== userId));
                // Remove flags from all nodes for this user
                setNodes(nds => nds.map(n => ({
                    ...n,
                    data: {
                        ...n.data,
                        flags: n.data.flags.filter(flagId => flagId !== userId)
                    }
                })));
            }, [setNodes]);

            // --- Drag and Drop Flag Logic (Feature 2.4) ---
            const onDragOver = useCallback((event) => {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
            }, []);

            const onDrop = useCallback((event) => {
                event.preventDefault();
                const reactFlowBounds = reactFlowWrapper.current.getBoundingClientRect();
                const userId = event.dataTransfer.getData('application/reactflow');
                if (!userId) return;

                const position = project({ x: event.clientX - reactFlowBounds.left, y: event.clientY - reactFlowBounds.top });
                const targetNode = nodes.find(node => 
                    position.x > node.position.x && position.x < node.position.x + node.width &&
                    position.y > node.position.y && position.y < node.position.y + node.height
                );

                if (targetNode) {
                    // Assign flag to the node
                    updateNodeData(targetNode.id, {
                        ...targetNode.data,
                        flags: [...new Set([...targetNode.data.flags, userId])] // Use Set to avoid duplicates
                    });
                }
            }, [project, nodes, updateNodeData]);

            // --- Command Bar Logic (Feature 2.3) ---
            const executeCommand = (command) => {
                const parts = command.match(/(?:[^\s"]+|"[^"]*")+/g) || [];
                if (parts.length === 0) return;

                const action = parts[0].toLowerCase();
                const args = parts.slice(1).map(arg => arg.replace(/"/g, ''));

                try {
                    if (action === 'add' && args[0] === 'node' && args[1]) {
                        const defaultProps = settings.globalProperties.reduce((acc, prop) => {
                           acc[prop] = 'N/A';
                           return acc;
                        }, {});

                        const newNode = {
                            id: nanoid.nanoid(),
                            type: 'custom',
                            position: { x: Math.random() * 400, y: Math.random() * 400 },
                            data: { label: args[1], progress: 0, properties: defaultProps, flags: [], notes: '' },
                        };
                        setNodes(nds => [...nds, newNode]);
                    } else if (action === 'add' && args[0] === 'edge' && args[1] && args[2]) {
                        const sourceNode = nodes.find(n => n.data.label.toLowerCase() === args[1].toLowerCase());
                        const targetNode = nodes.find(n => n.data.label.toLowerCase() === args[2].toLowerCase());
                        if (sourceNode && targetNode) {
                            onConnect({ source: sourceNode.id, target: targetNode.id });
                        } else {
                            alert('Could not find source or target node by that name.');
                        }
                    } else if (action === 'del' && args[0] === 'node' && args[1]) {
                         const nodeToDelete = nodes.find(n => n.data.label.toLowerCase() === args[1].toLowerCase());
                         if(nodeToDelete) deleteNode(nodeToDelete.id);
                         else alert('Node not found.');
                    } else {
                        alert('Unknown command or invalid arguments.');
                    }
                } catch (e) {
                    alert('Error executing command: ' + e.message);
                }
            };
            
            return html`
                <div className="main-content" ref=${reactFlowWrapper}>
                    <${ReactFlow}
                        nodes=${nodes}
                        edges=${edges}
                        onNodesChange=${onNodesChange}
                        onEdgesChange=${onEdgesChange}
                        onConnect=${onConnect}
                        onNodeClick=${onNodeClick}
                        onPaneClick=${onPaneClick}
                        onNodeMouseEnter=${onNodeMouseEnter}
                        onNodeMouseLeave=${onNodeMouseLeave}
                        onDrop=${onDrop}
                        onDragOver=${onDragOver}
                        nodeTypes=${nodeTypes}
                        fitView
                    >
                        <${Controls} />
                        <${Background} />
                    <//>
                    <${CommandBar} onCommand=${executeCommand} />
                    <button onClick=${() => setSettingsOpen(true)} style=${{position: 'absolute', top: '20px', right: '20px', zIndex: 10}}>Settings</button>
                    <${HoverTooltip} tooltip=${tooltip} />
                </div>
                <div className=${`sidebar ${!activeNode && 'collapsed'}`}>
                    ${activeNode ? html`<${NodeSidebar} activeNode=${activeNode} updateNodeData=${updateNodeData} deleteNode=${deleteNode}/>` 
                                : html`<${UserPanel} users=${users} addUser=${addUser} removeUser=${removeUser} />`}
                </div>
                <${SettingsModal} isOpen=${isSettingsOpen} onClose=${() => setSettingsOpen(false)} settings=${settings} updateSettings=${setSettings} />
            `;
        };
        
        // --- Render the App ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(html`
            <${ReactFlowProvider}>
                <${App} />
            <//>
        `);
    </script>
</body>
</html>